<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supply Shield Risk Management</title>
    <style>
        body {text-align: center; background-color: beige; color: black;}
    </style>
</head>
<body>
    <div id="authForm">
        <h2>Sign Up or Sign In</h2>
        <input type="email" placeholder="email" id="userEmail">
        <input type="password" placeholder="password" id="userPassword">  <br><br>
        <button id="signUpButton">Sign Up</button>
        <button id="signInButton">Sign In</button>
    </div>

    <div id="secretContent">
        <h3>This is top secret information that you can only see if</h3>
        <h1>AUTHENTICATED</h1>
        <button id="signOutButton">Sign Out</button>
    </div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <script type="module">
        console.log("ajax");
        
    </script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
        import {
            getAuth,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            onAuthStateChanged,
            signOut
        } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-auth.js";
       
      
        const firebaseConfig = {
            apiKey: "AIzaSyA0ZTEFlqXW_8GgO11P8fR-AFq4d5bJkk4",
            authDomain: "supply-shield-381721.firebaseapp.com",
            projectId: "supply-shield-381721",
            storageBucket: "supply-shield-381721.appspot.com",
            messagingSenderId: "506661741186",
            appId: "1:506661741186:web:ac20701607980421fb4a9b",
            measurementId: "G-4Q36BD44S7"
            };

            const createOrUpdateUser = async(email, role) => {

            const usersRef = collection(db, "users");

            await setDoc(doc(usersRef, email), {
                email: email, role: email });
            }
      
    
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        const userEmail = document.querySelector("#userEmail");
        const userRole = document.querySelector("#userEmail");
        const userPassword = document.querySelector("#userPassword");
        const authForm = document.querySelector("#authForm");
        const secretContent = document.querySelector("#secretContent");
        const signUpButton = document.querySelector("#signUpButton");
        const signInButton = document.querySelector("#signInButton");
        const signOutButton = document.querySelector("#signOutButton");
        const gatewayBaseUrl = "https://gateway-cmlmuykhqq-lm.a.run.app/"

        secretContent.style.display = 'none';

        const userSignUp = async() => {
            const signUpEmail = userEmail.value;
            const signUpRole= userRole.value;
            const signUpPassword = userPassword.value;
            createUserWithEmailAndPassword(auth, signUpEmail, signUpPassword)
            .then((userCredential) => {
                const user = userCredential.user;
                console.log(user);
                createOrUpdateUser(signUpEmail, signUpRole);
                alert("Your account has been created!");
            })
            .catch((error) => {
                const errorCode = error.code;
                const errorMessage = error.message;
                console.log(errorCode + errorMessage)
            })
        }

        const userSignIn = async() => {
            const signInEmail = userEmail.value;
            const signInPassword = userPassword.value;
            signInWithEmailAndPassword(auth, signInEmail, signInPassword)
            .then((userCredential) => {
                console.log("user");
                console.log(userCredential);
                alert("You have signed in successfully!");
                $.ajax({
    type: "GET",
    url: gatewayBaseUrl + "firebase",
    dataType: 'json',
    contentType: "application/json",
    headers: {
        "Cache-Control": "no-cache",
        "Authorization": "Bearer " + userCredential.user.accessToken,
    },
    data: {}, 
    success: function(resp){
        console.log(resp);
    }, 
    error: function(error){
        console.log(error);
    }    
});
            })
            .catch((error) => {
                const errorCode = error.code;
                const errorMessage = error.message;
                console.log(errorCode + errorMessage)
            })
        }

        const checkAuthState = async() => {
            onAuthStateChanged(auth, user => {
                if(user) {
                    authForm.style.display = 'none';
                    secretContent.style.display = 'block';
                }
                else {
                    authForm.style.display = 'block';
                    secretContent.style.display = 'none';
                }
            })
        }

        const userSignOut = async() => {
            await signOut(auth);
        }

        checkAuthState();

        signUpButton.addEventListener('click', userSignUp);
        signInButton.addEventListener('click', userSignIn);
        signOutButton.addEventListener('click', userSignOut);
      </script>
</body>
</html>
